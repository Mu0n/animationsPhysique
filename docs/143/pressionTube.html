<div id="imageContainer" class="aspectRation2-1"><div id="resistanceEcoulement"></div></div>

<div class="controls">
	<div class="details open">
		<h2 class="detailsAlwaysVisible" onclick="redraw('intro');">Introduction</h2>
		<p class="detailsToHide">Dans un tube, le débit doit nécessairement être le même en tout point&nbsp;: c'est une conséquence de la loi de la conservation de la matière. Puisque le débit ($Q$) peut être donné par: $$Q=Av$$ où $A$ est l'aire de la section du tube et $v$ la vitesse du fluide (liquide ou gaz).</p>
		<p class="detailsToHide">Si une partie du tube a une plus petite aire, cela aura pour effet d'augmenter la vitesse du fluide dans cette partie.</p>
		<p class="detailsToHide">Pour respecter le principe de conservation de l'énergie, une augmentation de la vitesse s'accompagnera d'une diminution de la pression dans cette partie du tube tel que montré par les manomètres à eau.</p>
		<label for="relativeDiameter">Diamètre de la partie centrale du tube&nbsp;:&nbsp;<input type="range" id="relativeDiameter" name="relativeDiameter" value="1" max="1.5" min="0.3" step="0.1" oninput="redraw()" onchange="redraw()"></label>

	</div>



</div>

<script>
  //Création de l'élément svg (l'image).
  var draw = SVG('resistanceEcoulement').viewbox({ x: 0, y: 0, width: 750, height: 375 });

	//Définition des paramètres par défaut du système.
	var relative = 1; //Diamètre relatif de l'ouvertude
	var diameter = 100; //Diamètre du tube

	var glassColor = new SVG.Color('#6699ff');
	var darkGlassColor = new SVG.Color('#4466cc');
	var lightGlassColor = new SVG.Color('#bbddff');
	var waterColor = new SVG.Color('#1133cc');

	/////////////////////////////////////////////////////////////////////
 	// Création des différents éléments de l'image pour l'introduction //
	/////////////////////////////////////////////////////////////////////

	//Dessin des manomètres
	var manometre = draw.path('M 220 150 v 170 a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v -170').fill('none').stroke({ width: 20, color: glassColor });
	var water = draw.path('M 220 260 v 60 a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v -60').fill('none').stroke({ width: 8, color: waterColor });

	//Dessin du tube
	var tubeTop = draw.path('M 100 90 v 10 h 500 v -10 z').attr({ fill: glassColor});
	var tubeBottom = draw.path('M 100 200 v 10 h 500 v -10 z').attr({ fill: glassColor});
	var tubeEnd = draw.path('M 600 90 v 10 a 20 50 0 0 1 0 100 v 10 a 24 60 0 0 0 0 -120 z').attr({ fill: darkGlassColor});
	var tubeInt = draw.path('M 100 100 a 20 50 0 0 1 0 100 h 500 a 20 50 0 0 0 0 -100 z').attr({ fill: lightGlassColor});

	var tubeLine1 = draw.path('M 250 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor }).hide();
	var tubeLine2 = draw.path('M 300 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor }).hide();
	var tubeLine3 = draw.path('M 400 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor }).hide();
	var tubeLine4 = draw.path('M 450 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor }).hide();


/*

	var path1 = tubeO.path('M 80 320 c 120 0 240 0 260 '+(8*(80-diameter)/25)+' s 120 -'+((80-diameter)/10)+' 160 -'+((80-diameter)/5)+' s 90 -'+(3*(80-diameter)/25)+' 120 -'+(3*(80-diameter)/25)).stroke('none').fill('none');
	var matrix = path1.matrixify();
	var path2 = tubeO.path('M 80 380 c 120 0 240 0 260 -'+(8*(80-diameter)/25)+' s 120 '+((80-diameter)/10)+' 160 '+((80-diameter)/5)+' s 90 '+(3*(80-diameter)/25)+' 120 '+(3*(80-diameter)/25)).stroke('none').fill('none');
	var matrix2 = path2.matrixify();

	var length = path1.length();

	var tubeMask = draw.mask().add(draw.path('M 80 310 a 16 40 0 0 1 0 80 h 530 a 16 40 0 0 0 0 -80 z').fill({ color: '#fff' }))

	SVG.easing['flow'] = function(t){
		var A = diameter*diameter/2500; //Aire entre 0.09 et 1
		var P = dP/20; //Pression entre 0.25 et 1
		var D = densite*2; //Densité entre 1 et 4

		var baseSpeed = A*Math.sqrt(P/D); //entre 0.0225 et 1
		var slowestSpeed = baseSpeed*Math.sqrt(diameter/50);

		var pos = [0, 0.2, 0.3, 0.4, 0.49-0.01*baseSpeed, 0.52+0.03*baseSpeed, 0.62+0.1*baseSpeed,1];
		var speeds = [baseSpeed, 0.7*baseSpeed+0.3*slowestSpeed, 0.35*baseSpeed+0.65*slowestSpeed, slowestSpeed ]
		var times = [0];
		for(var i=0; i<speeds.length; i++) { times[i+1]=times[i]+(pos[i+1]-pos[i])/speeds[i]; }
		var fastSpeed =


		//var d = (80 - diameter)/70;
		//var pos   = [0, 0.3, 0.42, 0.48, 0.52, 0.62, 1];
		//var times = [0, pos[1]+d*0.1, pos[2]+d*0.18, pos[3]+d*0.27, pos[4]+d*0.26, pos[5]+d*0.2, 1];

		for(var i=1; i<pos.length; i++) {
			if(t<times[i]) {
				return ( (t-times[i-1]) * (pos[i]-pos[i-1]) / (times[i]-times[i-1]) + pos[i-1]);
			}
		}
		return 1;

	}

	var particles=[], duree = 5000, particleN = 200;
	for(var i=0; i<particleN; i++) {
		particles[i] = tubeO.circle(2*Math.sqrt(densite)).fill('black').maskWith(tubeMask);

		particles[i].randomX =  Math.random();
		particles[i].randomY =  Math.random();

		particles[i].animate(duree, 'flow',particles[i].randomX*duree).during(function(pos, morph, eased){
			var p1 = new SVG.Point(path1.pointAt(eased * length)).transform(matrix);
			var p2 = new SVG.Point(path2.pointAt(eased * length)).transform(matrix);
			this.attr({ cx: p1.x, cy: this.randomY*p1.y+(1-this.randomY)*p2.y })
		}).loop(true)
	}



	//Dessine le tube pour l'écoulement
/*	var tube = draw.group();

	var glassTube = draw.gradient('linear', function(stop) {
	  stop.at({ offset: 0, color: '#9cf', opacity: 0.9 })
		stop.at({ offset: 0.1, color: '#9cf', opacity: 0.9 })
		stop.at({ offset: 0.1, color: '#9cf', opacity: 0.65 })
		stop.at({ offset: 0.5, color: '#fff', opacity: 0.65 })
		stop.at({ offset: 0.9, color: '#9cf', opacity: 0.65 })
		stop.at({ offset: 0.9, color: '#9cf', opacity: 0.9 })
		stop.at({ offset: 1, color: '#9cf', opacity: 0.9 })

	})

	var gaz = tube.rect(700,70).fill('white').move(50,30);
	tube.rect(700,70).fill(glassTube.from(0, 0).to(0, 1)).move(50,30);
	tube.path('M 150 100 v 80 a 100 100 0 0 0 200 0 v -80 h -30 v 80 a 70 70 0 0 1 -140 0 v -80 z').fill('#9cf');
	tube.rect(70,30).fill(darkCopper).move(550,100);
	tube.threads({width:40, length:30, threads:4, outward:true}).move(570,95).rotate(270);
	tube.rect(40,20).fill('url(#vPipe)').move(565,130);
	tube.circle(150).move(510,150).fill('#def').stroke({ width: 8, color: '#345' });
	//var aiguille = tube.path()

	var gaz2 = tube.rect(700,70).fill('white').move(50,363);
	tube.rect(700,70).fill(glassTube.from(0, 0).to(0, 1)).move(50,363);
	tube.path('M 150 433 v 80 a 100 100 0 0 0 200 0 v -80 h -30 v 80 a 70 70 0 0 1 -140 0 v -80 z').fill('#9cf');

*/

	//Redessine l'image en tenant compte des contrôles externes
  redraw();

  function redraw(part) {
		//Récupère les valeurs de l'utilisateur
		diameter =100;
		relative = parseFloat(document.getElementById("relativeDiameter").value);

		var delta = diameter*(1-relative)/2;
		tubeTop.plot('M 100 90 v 10 h 150 l 50 '+delta+' h 100 l 50 '+(-delta)+' h 150 v -10 h -150 l -50 '+delta+' h -100 l -50 '+(-delta)+' h -150').attr({ fill: glassColor});
		tubeBottom.plot('M 100 200 v 10 h 150 l 50 '+(-delta)+' h 100 l 50 '+(delta)+' h 150 v -10 h -150 l -50 '+(-delta)+' h -100 l -50 '+(delta)+' h -150').attr({ fill: glassColor});
		tubeInt.plot('M 100 100 a 20 50 0 0 1 0 100 h 150 l 50 '+(-delta)+' h 100 l 50 '+(delta)+' h 150 a 20 50 0 0 0 0 -100 h -150 l -50 '+delta+' h -100 l -50 '+(-delta)+' h -150').attr({ fill: lightGlassColor});

		if(relative==1) {
			tubeLine1.hide();
			tubeLine2.hide();
			tubeLine3.hide();
			tubeLine4.hide();
		}
		else {
			tubeLine1.show();
			tubeLine2.plot('M 300 '+(100+delta)+' a '+(20*relative)+' '+(50*relative)+' 0 0 1 0 '+(100*relative)).show();
			tubeLine3.plot('M 400 '+(100+delta)+' a '+(20*relative)+' '+(50*relative)+' 0 0 1 0 '+(100*relative)).show();
			tubeLine4.show();
		}

		water.plot('M 220 '+(260+delta)+' v '+(60-delta)+' a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v '+(-60-delta));

  }

</script>
