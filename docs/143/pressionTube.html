<div id="imageContainer" class="aspectRation2-1"><div id="resistanceEcoulement"></div></div>

<div class="controls">
	<div class="details open">
		<h2 class="detailsAlwaysVisible" onclick="redraw('intro');">Introduction</h2>
		<p class="detailsToHide">Dans un tube, le débit doit nécessairement être le même en tout point&nbsp;: c'est une conséquence de la loi de la conservation de la matière. Puisque le débit ($Q$) peut être donné par: $$Q=A\cdot v$$ où $A$ est l'aire de la section du tube et $v$ la vitesse du fluide (liquide ou gaz).</p>
		<p class="detailsToHide">Si une partie du tube a une plus petite aire, cela aura pour effet d'augmenter la vitesse du fluide dans cette partie.</p>
		<p class="detailsToHide">Pour respecter le principe de conservation de l'énergie, une augmentation de la vitesse s'accompagnera d'une diminution de la pression dans cette partie du tube tel que montré par les manomètres à eau.</p>
		<label for="relativeDiameter">Diamètre de la partie centrale du tube&nbsp;:&nbsp;<input type="range" id="relativeDiameter" name="relativeDiameter" value="0.75" max="1.5" min="0.4" step="0.01" oninput="redraw()" onchange="redraw()"></label>

	</div>



</div>

<script src='utils/includes/vector.js?v=<?php echo mt_rand(); ?>'></script>
<script>
  //Création de l'élément svg (l'image).
  var draw = SVG('resistanceEcoulement').viewbox({ x: 50, y: 25, width: 750, height: 375 });

	//Définition des paramètres par défaut du système.
	var relative = 1; //Diamètre relatif de l'ouvertude
	var diameter = 100; //Diamètre du tube

	var glassColor = new SVG.Color('#6699ff');
	var darkGlassColor = new SVG.Color('#4466cc');
	var lightGlassColor = new SVG.Color('#bbddff');
	var waterColor = new SVG.Color('#1133dd');

	/////////////////////////////////////////////////////////////////////
 	// Création des différents éléments de l'image pour l'introduction //
	/////////////////////////////////////////////////////////////////////

	//Dessin des manomètres
	var manometre = draw.path('M 220 150 v 170 a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v -170').fill('none').stroke({ width: 20, color: glassColor });
	var water = draw.path('M 220 260 v 60 a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v -60').fill('none').stroke({ width: 8, color: waterColor });

	//Dessin du tube
	var tubeTop = draw.path('M 100 90 v 10 h 500 v -10 z').attr({ fill: glassColor});
	var tubeBottom = draw.path('M 100 200 v 10 h 500 v -10 z').attr({ fill: glassColor});
	var tubeEnd = draw.path('M 600 90 v 10 a 20 50 0 0 1 0 100 v 10 a 24 60 0 0 0 0 -120 z').attr({ fill: darkGlassColor});
	var tubeInt = draw.path('M 100 100 a 20 50 0 0 1 0 100 h 500 a 20 50 0 0 0 0 -100 z').attr({ fill: lightGlassColor});

	//Dessin des lignes à l'intérieur du tube
	var tubeLines = draw.group();
	tubeLines.line1 = tubeLines.path('M 250 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor });
	tubeLines.line2 = tubeLines.path().fill('none').stroke({ width: 1, color: glassColor });
	tubeLines.line3 = tubeLines.path().fill('none').stroke({ width: 1, color: glassColor });
	tubeLines.line4 = tubeLines.path('M 450 100 a 20 50 0 0 1 0 100').fill('none').stroke({ width: 1, color: glassColor });

	//Dessin des lignes et du texte pour la variation de pressionTube
	var pressure = draw.group();
	pressure.line1 = pressure.path().fill('none').stroke({ width: 1, color: 'black', dasharray: '10,12' });
	pressure.line2 = pressure.path().fill('none').stroke({ width: 1, color: 'black', dasharray: '10,12' });
	pressure.quoteline = pressure.path().fill('none').stroke({ width: 1, color: 'black' }).vector({size:1.5,position:'both',style:'curved'});
	pressure.dP = pressure.text("ΔP").font({family: 'Helvetica', size: 24, anchor: 'middle'}).move(430,247);
	pressure.explication1 = pressure.text("Puisque la partie centrale est\nplus étroite, le fluide s'y déplace\nplus rapidement et la pression y\nest plus faible.").font({family: 'Helvetica', size: 18}).move(470,230);
	pressure.explication2 = pressure.text("Puisque la partie centrale est\nplus large, le fluide s'y déplace\nplus lentement et la pression y\nest plus élevée.").font({family: 'Helvetica', size: 18}).move(470,230);



	var path1 = draw.path('M 100 -45 h 500').stroke('black').fill('none');

	var tubeMask = draw.mask().add(draw.path('M 100 100 a 20 50 0 0 1 0 100 v50 h 500 v-50 a 20 50 0 0 0 0 -100 v -50 h -500 z').fill({ color: '#fff' }))

	function getX(t) { //Détermine la position x des particules en fonction du temps.
		//La particule doit aller à la vitesse 1 entre x=0 et 150 et après 350, vitesse 2 entre 200 et 300
		var steps = [140,60,100];
		var v1=700;
		var relative = parseFloat(document.getElementById("relativeDiameter").value);
		var v2 = v1/(relative**2);
		var a = (v2**2-v1**2)/(2*steps[1]);

		var tmax = steps[0]/v1;
		if(t<tmax || relative==1) {return v1*t;} //Si relative==1, les particules vont toujours à la vitesse v1...

		t -= tmax;
		tmax = (-v1 + Math.sqrt(v1**2+2*a*steps[1]))/a;
		if (t < tmax) {return steps[0]+v1*t+0.5*a*t**2;}

		t -= tmax;
		tmax = steps[2]/v2;
		if (t < tmax) {return steps[0]+steps[1]+v2*t;}

		t -= tmax;
		tmax = (v2 - Math.sqrt(v2**2-2*a*steps[1]))/a;
		if (t < tmax) {return steps[0]+steps[1]+steps[2]+v2*t-0.5*a*t**2;}

		t -= tmax;
		return steps[0]+2*steps[1]+steps[2]+v1*t;
	}

	var particles=[], duree = 10000, particleN = 200;
	for(var i=0; i<particleN; i++) {
		particles[i] = draw.circle(3).fill('black').maskWith(tubeMask);

		particles[i].randomX =  Math.random();
		particles[i].randomY =  Math.random()*2-1;

		particles[i].animate(duree, '-',-particles[i].randomX*duree).during(function(t, morph, eased){
			var point = path1.pointAt(getX(t))

			this.attr({ cx: point.x, cy: this.randomY*point.y+150 })
		}).loop(true)
	}


	//Redessine l'image en tenant compte des contrôles externes
  redraw();

  function redraw(part) {
		//Récupère les valeurs de l'utilisateur
		diameter =100;
		relative = parseFloat(document.getElementById("relativeDiameter").value);

		var delta = diameter*(1-relative)/2;
		tubeTop.plot('M 100 90 v 10 h 150 l 50 '+delta+' h 100 l 50 '+(-delta)+' h 150 v -10 h -150 l -50 '+delta+' h -100 l -50 '+(-delta)+' h -150').attr({ fill: glassColor});
		tubeBottom.plot('M 100 200 v 10 h 150 l 50 '+(-delta)+' h 100 l 50 '+(delta)+' h 150 v -10 h -150 l -50 '+(-delta)+' h -100 l -50 '+(delta)+' h -150').attr({ fill: glassColor});
		tubeInt.plot('M 100 100 a 20 50 0 0 1 0 100 h 150 l 50 '+(-delta)+' h 100 l 50 '+(delta)+' h 150 a 20 50 0 0 0 0 -100 h -150 l -50 '+delta+' h -100 l -50 '+(-delta)+' h -150').attr({ fill: lightGlassColor});

		if(relative==1) {
			tubeLines.hide();
			pressure.hide();

			path1.plot('M 100 -45 h 550');
		}
		else {
			tubeLines.line2.plot('M 300 '+(100+delta)+' a '+(20*relative)+' '+(50*relative)+' 0 0 1 0 '+(100*relative));
			tubeLines.line3.plot('M 400 '+(100+delta)+' a '+(20*relative)+' '+(50*relative)+' 0 0 1 0 '+(100*relative));
			tubeLines.show();
			pressure.show();

			if(relative>1) {
				pressure.explication1.hide();
				pressure.explication2.show();

				var closePosition = 5*(1-relative);
				path1.plot('M 100 -45 c 140 0, 140 0, 150 '+(closePosition)+' s 30 '+(delta-closePosition)+', 100 '+(delta-closePosition)+' s 90 '+(-delta+2*closePosition)+', 100 '+(-delta+closePosition)+' s 10 '+(-closePosition)+', 200 '+(-closePosition));
			}
			else {
				pressure.explication1.show();
				pressure.explication2.hide();

				var closePosition = 5*(1-relative);
				path1.plot('M 100 -45 c 190 0, 190 '+(delta-2*closePosition)+', 200 '+(delta-closePosition)+' s 90 '+closePosition+', 100 0 s 10 '+(-delta+closePosition)+', 250 '+(-delta+closePosition));
			}
		}

		var pressureDelta = 85*(1-relative)
		water.plot('M 220 '+(260+pressureDelta)+' v '+(60-pressureDelta)+' a 20 20 0 0 0 20 20 h 70 a 20 20 0 0 0 20 -20 v '+(-60-pressureDelta));
		pressure.line1.plot('M 215 '+(260+pressureDelta)+' h 190');
		pressure.line2.plot('M 325 '+(260-pressureDelta)+' h 80');
		pressure.quoteline.plot('M 396.5 '+(260-pressureDelta)+' v '+2*pressureDelta);
  }

</script>
